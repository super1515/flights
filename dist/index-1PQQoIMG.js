var j=Object.defineProperty;var P=(d,t,e)=>t in d?j(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var u=(d,t,e)=>(P(d,typeof t!="symbol"?t+"":t,e),e),N=(d,t,e)=>{if(!t.has(d))throw TypeError("Cannot "+e)};var s=(d,t,e)=>(N(d,t,"read from private field"),e?e.call(d):t.get(d)),m=(d,t,e)=>{if(t.has(d))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(d):t.set(d,e)},h=(d,t,e,o)=>(N(d,t,"write to private field"),o?o.call(d,e):t.set(d,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();var L,B,w;class O{constructor({airTypeID:t=null,name:e,capacity:o}){m(this,L,null);m(this,B,"");m(this,w,-1);h(this,L,t),h(this,B,e),h(this,w,o)}get airTypeID(){return s(this,L)}get airTypeName(){return s(this,B)}get airTypeCapacity(){return s(this,w)}}L=new WeakMap,B=new WeakMap,w=new WeakMap;class y{static async getFlights(){try{const t=await fetch("http://localhost:4321/flights"),e=await t.json();return t.status!==200?Promise.reject(e):e.flights}catch(t){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:t.message})}}static async getAirTypes(){try{const t=await fetch("http://localhost:4321/airTypes"),e=await t.json();return t.status!==200?Promise.reject(e):e.airTypes}catch(t){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:t.message})}}static async addFlight({flightID:t,direction:e,date:o,airType:i,position:n=-1}={flightID:null,direction:"",date:null,airType:null,position:-1}){try{const a=await fetch("http://localhost:4321/flights",{method:"POST",body:JSON.stringify({flightID:t,direction:e,date:o,airType:i,position:n}),headers:{"Content-Type":"application/json"}});if(a.status!==200){const l="uq_direction_date",r="Такой рейс уже существует!";let c=await a.json();return c.message.indexOf(l)!==-1&&(c.message=r),Promise.reject(c)}return{timestamp:new Date().toISOString(),message:`Рейс '${e}' добавлен`}}catch(a){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:a.message})}}static async addBooking({bookingID:t,name:e,position:o=-1,flightID:i}={bookingID:null,name:"",position:-1,flightID:null}){try{const n=await fetch("http://localhost:4321/bookings",{method:"POST",body:JSON.stringify({bookingID:t,name:e,position:o,flightID:i}),headers:{"Content-Type":"application/json"}});if(n.status!==200){const a="uq_name",l="Человек с таким ФИО уже существует!";let r=await n.json();return r.message.indexOf(a)!==-1&&(r.message=l),Promise.reject(r)}return{timestamp:new Date().toISOString(),message:`Бронь '${e}' добавлена`}}catch(n){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:n.message})}}static async updateBooking({bookingID:t,name:e,position:o=-1}={bookingID:null,name:"",position:-1}){try{const i=await fetch(`http://localhost:4321/bookings/${t}`,{method:"PATCH",body:JSON.stringify({name:e,position:o}),headers:{"Content-Type":"application/json"}});if(i.status!==200){const n=await i.json();return Promise.reject(n)}return{timestamp:new Date().toISOString(),message:`Параметры ФИО '${e}' изменены`}}catch(i){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:i.message})}}static async updateFlight({flightID:t,direction:e,date:o,airType:i}={flightID:null,direction:"",date:null,airType:null}){try{const n=await fetch(`http://localhost:4321/flights/${t}`,{method:"PATCH",body:JSON.stringify({direction:e,date:o,airType:i}),headers:{"Content-Type":"application/json"}});if(n.status!==200){const a=await n.json();return Promise.reject(a)}return{timestamp:new Date().toISOString(),message:`Параметры рейса '${e}' изменены`}}catch(n){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:n.message})}}static async updateBookings({reorderedTasks:t=[]}={reorderedTasks:[]}){try{const e=await fetch("http://localhost:4321/bookings",{method:"PATCH",body:JSON.stringify({reorderedTasks:t}),headers:{"Content-Type":"application/json"}});if(e.status!==200){const o=await e.json();return Promise.reject(o)}return{timestamp:new Date().toISOString(),message:"Порядок броней изменен"}}catch(e){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:e.message})}}static async deleteFlight({flightID:t}={flightID:null}){try{const e=await fetch(`http://localhost:4321/flights/${t}`,{method:"DELETE"});if(e.status!==200){const o=await e.json();return Promise.reject(o)}return{timestamp:new Date().toISOString(),message:`Рейс ${t} удален`}}catch(e){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:e.message})}}static async deleteBooking({bookingID:t}={bookingID:null}){try{const e=await fetch(`http://localhost:4321/bookings/${t}`,{method:"DELETE"});if(e.status!==200){const o=await e.json();return Promise.reject(o)}return{timestamp:new Date().toISOString(),message:`Бронь ${t} удалена`}}catch(e){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:e.message})}}static async moveBooking({bookingID:t,srcflightID:e,destflightID:o}={bookingID:null,srcflightID:null,destflightID:null}){try{const i=await fetch("http://localhost:4321/flights",{method:"PATCH",body:JSON.stringify({bookingID:t,srcflightID:e,destflightID:o}),headers:{"Content-Type":"application/json"}});if(i.status!==200){const n=await i.json();return Promise.reject(n)}return{timestamp:new Date().toISOString(),message:`Бронь ${t} перемещена`}}catch(i){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:i.message})}}}var k,D,E;class H{constructor({bookingID:t=null,name:e,position:o}){m(this,k,null);m(this,D,"");m(this,E,-1);h(this,k,t||crypto.randomUUID()),h(this,D,e),h(this,E,o)}get bookingID(){return s(this,k)}get bookingName(){return s(this,D)}set bookingName(t){typeof t=="string"&&h(this,D,t)}get taskPosition(){return s(this,E)}set taskPosition(t){typeof t=="number"&&t>=0&&h(this,E,t)}render(){const t=document.createElement("li");t.classList.add("flight__bookings-list-item","booking"),t.setAttribute("id",s(this,k)),t.setAttribute("draggable",!0),t.addEventListener("dragstart",l=>{l.target.classList.add("booking_selected"),localStorage.setItem("movedbookingID",s(this,k))}),t.addEventListener("dragend",l=>{l.target.classList.remove("booking_selected")});const e=document.createElement("span");e.classList.add("task__text"),e.innerHTML=s(this,D),t.appendChild(e);const o=document.createElement("div");o.classList.add("task__controls");const i=document.createElement("div");i.classList.add("task__controls-row");const n=document.createElement("button");n.setAttribute("type","button"),n.classList.add("task__control-btn","edit-icon"),n.addEventListener("click",()=>{localStorage.setItem("editbookingID",s(this,k)),document.getElementById("modal-edit-booking").showModal()}),i.appendChild(n);const a=document.createElement("button");return a.setAttribute("type","button"),a.classList.add("task__control-btn","delete-icon"),a.addEventListener("click",()=>{localStorage.setItem("deletebookingID",s(this,k));const l=document.getElementById("modal-delete-booking");l.querySelector(".app-modal__question").innerHTML=`Бронь '${s(this,D)}' будет удалена. Продолжить?`,l.showModal()}),i.appendChild(a),o.appendChild(i),t.appendChild(o),t}}k=new WeakMap,D=new WeakMap,E=new WeakMap;var p,S,_,I,f,v;class M{constructor({flightID:t=null,direction:e,date:o,airType:i,position:n,onDropTaskInflight:a,addNotification:l}){m(this,p,[]);m(this,S,"");m(this,_,null);m(this,I,null);m(this,f,null);m(this,v,-1);u(this,"pushTask",({booking:t})=>s(this,p).push(t));u(this,"getTaskByID",({bookingID:t})=>s(this,p).find(e=>e.bookingID===t));u(this,"deleteBooking",({bookingID:t})=>{const e=s(this,p).findIndex(i=>i.bookingID===t);if(e===-1)return;const[o]=s(this,p).splice(e,1);return o});u(this,"reorderTasks",async()=>{const t=Array.from(document.querySelector(`[id="${s(this,f)}"] .flight__bookings-list`).children,o=>o.getAttribute("id")),e=[];if(t.forEach((o,i)=>{const n=s(this,p).find(a=>a.bookingID===o);console.log(n),n.taskPosition!==i&&(n.taskPosition=i,e.push({bookingID:o,position:i}))}),e.length>0)try{await y.updateBookings({reorderedTasks:e})}catch(o){this.addNotification({text:o.message,type:"error"}),console.error(o)}});u(this,"appendNewTask",async({name:t})=>{try{const e=crypto.randomUUID(),o=await y.addBooking({bookingID:e,name:t,position:s(this,p).length,flightID:s(this,f)});this.addNewTaskLocal({bookingID:e,name:t,position:s(this,p).length}),this.addNotification({text:o.message,type:"success"})}catch(e){this.addNotification({text:e.message,type:"error"}),console.error(e)}});u(this,"addNewTaskLocal",({bookingID:t=null,name:e,position:o})=>{const i=new H({bookingID:t,name:e,position:o});console.log(s(this,p)),s(this,p).push(i);const n=i.render();document.querySelector(`[id="${s(this,f)}"] .flight__bookings-list`).appendChild(n)});h(this,S,e),h(this,_,o),h(this,I,i),h(this,f,t||crypto.randomUUID()),h(this,v,n),this.onDropTaskInflight=a,this.addNotification=l}get flightID(){return s(this,f)}get flightDirection(){return s(this,S)}set flightDirection(t){typeof t=="string"&&h(this,S,t)}get flightDate(){return s(this,_)}set flightDate(t){h(this,_,t)}get flightAirType(){return s(this,I)}set flightAirType(t){h(this,I,t)}get bookingsCount(){return s(this,p).length}get flightPosition(){return s(this,v)}render(){const t=document.createElement("li");t.classList.add("flights-list__item","flight"),t.setAttribute("id",s(this,f)),t.addEventListener("dragstart",()=>localStorage.setItem("srcflightID",s(this,f))),t.addEventListener("drop",this.onDropTaskInflight);const e=document.createElement("h2");e.classList.add("flight__name"),console.log(s(this,I)),e.innerHTML=s(this,S),t.appendChild(e);const o=document.createElement("h3");o.classList.add("flight__air-type"),o.innerHTML=s(this,I).airTypeName+` [${s(this,I).airTypeCapacity}]`,t.appendChild(o);const i=document.createElement("h3");i.classList.add("flight__date"),i.innerHTML=new Date(Date.parse(s(this,_))).toLocaleString("ru"),t.appendChild(i);const n=document.createElement("div");n.classList.add("task__controls"),n.style="margin-bottom: 1vw;";const a=document.createElement("div");a.classList.add("task__controls-row");const l=document.createElement("button");l.setAttribute("type","button"),l.classList.add("task__control-btn","edit-icon"),l.addEventListener("click",()=>{localStorage.setItem("editFlightID",s(this,f)),document.getElementById("modal-edit-flight").showModal()}),a.appendChild(l);const r=document.createElement("button");r.setAttribute("type","button"),r.classList.add("task__control-btn","delete-icon"),r.addEventListener("click",()=>{localStorage.setItem("deleteFlightID",s(this,f));const C=document.getElementById("modal-delete-flight");C.querySelector(".app-modal__question").innerHTML=`Рейс '${s(this,S)}' будет удален. Продолжить?`,C.showModal()}),a.appendChild(r),n.appendChild(a),t.appendChild(n);const c=document.createElement("ul");c.classList.add("flight__bookings-list"),t.appendChild(c);const T=document.createElement("button");T.setAttribute("type","button"),T.classList.add("flight__add-booking-btn"),T.innerHTML="&#10010; Добавить бронь",T.addEventListener("click",()=>{localStorage.setItem("addBookingflightID",s(this,f)),document.getElementById("modal-add-booking").showModal()}),t.appendChild(T);const q=document.querySelector(".flight-adder");q.parentElement.insertBefore(t,q)}}p=new WeakMap,S=new WeakMap,_=new WeakMap,I=new WeakMap,f=new WeakMap,v=new WeakMap;var g,b;class x{constructor(){m(this,g,[]);m(this,b,[]);u(this,"onEscapeKeydown",t=>{if(t.key==="Escape"){const e=document.querySelector(".flight-adder__input");e.style.display="none",e.value="",document.querySelector(".flight-adder__btn").style.display="inherit"}});u(this,"onInputKeydown",async t=>{if(t.key!=="Enter")return;const e=document.querySelector(".flight-adder__input_direction"),o=document.querySelector(".flight-adder__input_date"),i=document.querySelector(".flight-adder__input_air-type");if(console.log(e.value),console.log(o.value),console.log(i[i.selectedIndex].id),t.target.value){const n=crypto.randomUUID();try{const a=await y.addFlight({flightID:n,direction:e.value,date:o.value,airType:i[i.selectedIndex].id,position:s(this,g).length});console.log(t.target);const l=new M({flightID:n,direction:e.value,date:o.value,airType:s(this,b).find(r=>r.airTypeID===i[i.selectedIndex].id),position:s(this,g).length,onDropTaskInflight:this.onDropTaskInflight,addNotification:this.addNotifications});s(this,g).push(l),l.render(),this.addNotifications({text:a.message,type:"success"})}catch(a){this.addNotifications({text:a.message,type:"error"})}}document.querySelector(".flight-adder__input").style.display="none",t.target.value="",document.querySelector(".flight-adder__btn").style.display="inherit"});u(this,"onDropTaskInflight",async t=>{t.stopPropagation();const e=t.currentTarget;e.classList.remove("flight_droppable"),e.classList.remove("flight_undroppable");const o=localStorage.getItem("movedbookingID"),i=localStorage.getItem("srcflightID"),n=e.getAttribute("id");if(localStorage.setItem("movedbookingID",""),localStorage.setItem("srcflightID",""),!e.querySelector(`[id="${o}"]`)||e.matches(".flight_undroppable"))return;const a=s(this,g).find(r=>r.flightID===i),l=s(this,g).find(r=>r.flightID===n);try{if(i!==n){await y.moveBooking({bookingID:o,srcflightID:i,destflightID:n});const r=a.deleteBooking({bookingID:o});l.pushTask({booking:r}),await a.reorderTasks()}await l.reorderTasks(),console.log(`Задача '${o}' перемещена`),this.addNotifications({text:`Задача '${o}' перемещена`,type:"success"})}catch(r){this.addNotifications({text:r.message,type:"error"}),console.error(r)}});u(this,"editFlight",async({flightID:t,newFlightDirection:e,newFlightDate:o,newFlightAirType:i})=>{let n=s(this,g).find(c=>c.flightID===t);const a=n.flightDirection,l=n.flightDate,r=s(this,b).find(c=>c.airTypeID===i);if(!(!e||!o||!i||e===a&&o===l))try{const c=await y.updateFlight({flightID:t,direction:e,date:o,airType:i});n.flightDirection=e,n.flightDate=o,n.flightAirType=i,document.querySelector(`[id="${t}"] .flight__name`).innerHTML=e,document.querySelector(`[id="${t}"] .flight__air-type`).innerHTML=r.airTypeName+` [${r.airTypeCapacity}]`,document.querySelector(`[id="${t}"] .flight__date`).innerHTML=new Date(Date.parse(o)).toLocaleString("ru"),this.addNotifications({text:c.message,type:"success"})}catch(c){this.addNotifications({text:c.message,type:"error"}),console.error(c)}});u(this,"deleteFlight",async({flightID:t})=>{let e=s(this,g).find(o=>o.flightID===t);try{const o=await y.deleteFlight({flightID:t});console.log(s(this,g)),console.log(e.flightID),s(this,g).splice(s(this,g).findIndex(i=>i.flightID===e.flightID),1),console.log(s(this,g)),document.getElementById(e.flightID).remove(),console.log(o),this.addNotifications({text:o.message,type:"success"})}catch(o){this.addNotifications({text:o.message,type:"error"}),console.error(o)}});u(this,"editBooking",async({bookingID:t,newbookingName:e})=>{let o=null;for(let n of s(this,g))if(o=n.getTaskByID({bookingID:t}),o)break;const i=o.bookingName;if(!(!e||e===i))try{const n=await y.updateBooking({bookingID:t,name:e});o.bookingName=e,document.querySelector(`[id="${t}"] span.task__text`).innerHTML=e,this.addNotifications({text:n.message,type:"success"})}catch(n){this.addNotifications({text:n.message,type:"error"}),console.error(n)}});u(this,"deleteBooking",async({bookingID:t})=>{let e=null,o=null;for(let i of s(this,g))if(o=i,e=i.getTaskByID({bookingID:t}),e)break;try{const i=await y.deleteBooking({bookingID:t});o.deleteBooking({bookingID:t}),document.getElementById(t).remove(),console.log(i),this.addNotifications({text:i.message,type:"success"})}catch(i){this.addNotifications({text:i.message,type:"error"}),console.error(i)}});u(this,"addNotifications",({text:t,type:e})=>{const o=document.getElementById("app-notifications"),i=crypto.randomUUID(),n=document.createElement("div");n.classList.add("notification",e==="success"?"notification-success":"notification-error"),n.setAttribute("id",i),n.innerHTML=t,o.appendChild(n),setTimeout(()=>{document.getElementById(i).remove()},5e3)})}initaddBookingModal(){const t=document.getElementById("modal-add-booking"),e=()=>{t.close(),localStorage.setItem("addBookingflightID",""),t.querySelector(".app-modal__input").value=""},o=()=>{const i=localStorage.getItem("addBookingflightID"),n=t.querySelector(".app-modal__input");i&&n.value&&s(this,g).find(a=>a.flightID===i).appendNewTask({name:n.value}),e()};t.querySelector(".modal-ok-btn").addEventListener("click",o),t.querySelector(".modal-cancel-btn").addEventListener("click",e),t.addEventListener("close",e)}initEditBookingModal(){const t=document.getElementById("modal-edit-booking"),e=()=>{t.close(),localStorage.setItem("editbookingID",""),t.querySelector(".app-modal__input").value=""},o=()=>{const i=localStorage.getItem("editbookingID"),n=t.querySelector(".app-modal__input");i&&n.value&&this.editBooking({bookingID:i,newbookingName:n.value}),e()};t.querySelector(".modal-ok-btn").addEventListener("click",o),t.querySelector(".modal-cancel-btn").addEventListener("click",e),t.addEventListener("close",e)}initEditFlightModal(){const t=document.getElementById("modal-edit-flight"),e=t.querySelector(".app-modal__direction"),o=t.querySelector(".app-modal__date"),i=t.querySelector(".app-modal__date__air-type"),n=document.getElementById("modal-airType");n.innerHTML="";for(const r of s(this,b)){const c=document.createElement("option");c.id=r.airTypeID,c.innerHTML=`${r.airTypeName} [${r.airTypeCapacity}]`,n.appendChild(c)}const a=()=>{t.close(),localStorage.setItem("editFlightID",""),e.value="",o.value="",i.selectedIndex=0},l=()=>{const r=localStorage.getItem("editFlightID");r&&e.value&&o.value&&i[i.selectedIndex].id&&this.editFlight({flightID:r,newFlightDirection:e.value,newFlightDate:o.value,newFlightAirType:i[i.selectedIndex].id}),a()};t.querySelector(".modal-ok-btn").addEventListener("click",l),t.querySelector(".modal-cancel-btn").addEventListener("click",a),t.addEventListener("close",a)}initDeleteFlightModal(){const t=document.getElementById("modal-delete-flight"),e=()=>{t.close(),localStorage.setItem("deleteFlightID","")},o=()=>{const i=localStorage.getItem("deleteFlightID");i&&this.deleteFlight({flightID:i}),e()};t.querySelector(".modal-ok-btn").addEventListener("click",o),t.querySelector(".modal-cancel-btn").addEventListener("click",e),t.addEventListener("close",e)}initdeleteBookingModal(){const t=document.getElementById("modal-delete-booking"),e=()=>{t.close(),localStorage.setItem("deletebookingID","")},o=()=>{const i=localStorage.getItem("deletebookingID");i&&this.deleteBooking({bookingID:i}),e()};t.querySelector(".modal-ok-btn").addEventListener("click",o),t.querySelector(".modal-cancel-btn").addEventListener("click",e),t.addEventListener("close",e)}initNotifications(){document.getElementById("app-notifications").show()}async init(){const t=await y.getAirTypes();for(const e of t){const o=new O({airTypeID:e.id,name:e.name,capacity:e.capacity});s(this,b).push(o)}console.log(t),document.querySelector(".flight-adder__btn").addEventListener("click",e=>{e.target.style.display="none";const o=document.querySelector(".flight-adder__input"),i=document.getElementById("airType");i.innerHTML="";for(const n of s(this,b)){const a=document.createElement("option");a.id=n.airTypeID,a.innerHTML=`${n.airTypeName} [${n.airTypeCapacity}]`,i.appendChild(a)}o.style.display="inherit",o.focus()}),document.addEventListener("keydown",this.onEscapeKeydown),document.querySelector(".flight-adder__input").addEventListener("keydown",this.onInputKeydown),document.getElementById("theme-switch").addEventListener("change",e=>{e.target.checked?document.body.classList.add("dark-theme"):document.body.classList.remove("dark-theme")}),this.initaddBookingModal(),this.initEditBookingModal(),this.initdeleteBookingModal(),this.initEditFlightModal(),this.initDeleteFlightModal(),this.initNotifications(),document.addEventListener("dragover",e=>{e.preventDefault();const o=document.querySelector(".booking.booking_selected"),i=localStorage.getItem("srcflightID"),n=e.target,a=document.querySelector(".flight_droppable"),l=document.querySelector(".flight_undroppable");let r=e.target;for(;!r.matches(".flight")&&r!==document.body;)r=r.parentElement;if((r!==a||r!==l)&&(a&&a.classList.remove("flight_droppable"),l&&l.classList.remove("flight_undroppable"),r.matches(".flight"))){const c=s(this,g).find(T=>T.flightID===r.getAttribute("id"));r.getAttribute("id")===i||c.flightAirType.airTypeCapacity<c.bookingsCount+1?r.classList.add("flight_undroppable"):r.classList.add("flight_droppable")}!r.matches(".flight")||o===n||r.matches(".flight_droppable")&&r.querySelector(".flight__bookings-list").appendChild(o)});try{const e=await y.getFlights();for(const o of e){const i=new M({flightID:o.flightID,direction:o.direction,date:o.date,airType:s(this,b).find(n=>n.airTypeID===o.airType),position:o.position,onDropTaskInflight:this.onDropTaskInflight,addNotification:this.addNotifications});s(this,g).push(i),i.render();for(const n of o.bookings)i.addNewTaskLocal({bookingID:n.bookingID,name:n.name,position:n.position})}}catch(e){this.addNotifications({text:e.message,type:"error"}),console.error(e)}}}g=new WeakMap,b=new WeakMap;document.addEventListener("DOMContentLoaded",()=>{new x().init()});
